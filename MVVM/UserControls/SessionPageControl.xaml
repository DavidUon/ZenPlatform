<UserControl x:Class="ZenPlatform.MVVM.UserControls.SessionPageControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="{StaticResource BrushSurface}"
             VerticalAlignment="Stretch">
    <Grid ClipToBounds="True">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" MinHeight="0" />
        </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="160" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="140" />
            </Grid.ColumnDefinitions>

            <Grid Grid.Row="0" Grid.Column="0" Margin="4,0,8,0" MinHeight="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Button Grid.Row="0"
                            Content="策略設定"
                            HorizontalAlignment="Stretch"
                            Height="45"
                            Margin="0,0,0,6"
                            Click="OnStrategySettingsClick" />
                    <Button Grid.Row="1"
                            Content="{Binding BacktestButtonText}"
                            HorizontalAlignment="Stretch"
                            IsEnabled="{Binding IsBacktestButtonEnabled}"
                            Click="OnHistoryBacktestClick" />
                    <Button Grid.Row="2"
                            Margin="0,6,0,0"
                            Content="回測瀏覽器"
                            HorizontalAlignment="Stretch"
                            Click="OnOpenBacktestViewerClick" />
                </Grid>

                <Border Grid.Row="2"
                        BorderBrush="{StaticResource BrushInputBorder}"
                        BorderThickness="1"
                        CornerRadius="4"
                        VerticalAlignment="Bottom"
                        Padding="8"
                        Margin="0,0,0,8"
                        Background="#1D1D1D"
                        Cursor="Hand"
                        MouseLeftButtonUp="OnTrendCardMouseLeftButtonUp">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsStrategyRunning}" Value="True" />
                                        <Condition Binding="{Binding IsBacktestActive}" Value="False" />
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible" />
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="{Binding TrendModeText}"
                                   HorizontalAlignment="Center"
                                   TextAlignment="Center"
                                   Margin="0,0,0,6"
                                   Foreground="{StaticResource BrushText}" />
                        <TextBlock Text="{Binding TrendStatusText}"
                                   HorizontalAlignment="Center"
                                   TextAlignment="Center"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="{Binding TrendStatusBrush}" />
                    </StackPanel>
                </Border>

                <!-- This Grid.Row=2 is the stretching row, no content needed here explicitly -->

                <Grid Grid.Row="3">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="70" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="目前部位" Margin="3,2,5,2" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="0" Grid.Column="1"
                               Text="{Binding SummaryPositionText}"
                               VerticalAlignment="Center" />

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="浮動損益" Margin="3,2,5,2" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="1" Grid.Column="1"
                               Text="{Binding SummaryFloatProfit, StringFormat={}{0:F1}}"
                               VerticalAlignment="Center" />

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="平倉損益" Margin="3,2,5,2" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="2" Grid.Column="1"
                               Text="{Binding SummaryRealizedProfit, StringFormat={}{0:F1}}"
                               VerticalAlignment="Center" />

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="交易次數" Margin="3,2,5,2" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="3" Grid.Column="1"
                               Text="{Binding SummaryTradeCount}"
                               VerticalAlignment="Center" />

                    <TextBlock Grid.Row="4" Grid.Column="0" Text="總損益" Margin="3,2,5,4" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="4" Grid.Column="1"
                               Text="{Binding SummaryTotalProfit, StringFormat={}{0:F1}}"
                               Margin="0,0,0,2"
                               VerticalAlignment="Center" />
                </Grid>
            </Grid>

            <DataGrid x:Name="SessionGrid" Grid.Row="0" Grid.Column="1"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      IsReadOnly="True"
                      SelectionUnit="FullRow"
                      SelectionMode="Single"
                      HeadersVisibility="Column"
                      ItemsSource="{Binding Sessions}"
                      ContextMenuOpening="OnSessionGridContextMenuOpening"
                      PreviewMouseRightButtonDown="OnSessionGridRightButtonDown"
                      PreviewMouseLeftButtonDown="OnSessionGridLeftButtonDown"
                      LostFocus="OnSessionGridLostFocus"
                      Background="{StaticResource BrushInputBackground}"
                      Foreground="{StaticResource BrushText}"
                      BorderBrush="{StaticResource BrushBorder}"
                      BorderThickness="1"
                      GridLinesVisibility="Horizontal"
                      RowBackground="#FF1F1F1F"
                      AlternatingRowBackground="#FF232323"
                      VerticalAlignment="Stretch"
                      MinHeight="0">
                <DataGrid.Resources>
                    <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="{StaticResource ColorInputBorder}" />
                    <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="{StaticResource ColorText}" />
                    <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" Color="{StaticResource ColorInputBorder}" />
                    <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightTextBrushKey}" Color="{StaticResource ColorText}" />
                </DataGrid.Resources>
                <DataGrid.ColumnHeaderStyle>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="#FF2A2A2A" />
                        <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                        <Setter Property="BorderBrush" Value="{StaticResource BrushBorder}" />
                        <Setter Property="BorderThickness" Value="0,0,1,1" />
                        <Setter Property="HorizontalContentAlignment" Value="Center" />
                        <Setter Property="VerticalContentAlignment" Value="Center" />
                    </Style>
                </DataGrid.ColumnHeaderStyle>
                <DataGrid.CellStyle>
                    <Style TargetType="{x:Type DataGridCell}">
                        <Setter Property="Background" Value="Transparent" />
                        <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                        <Setter Property="HorizontalContentAlignment" Value="Center" />
                        <Setter Property="VerticalContentAlignment" Value="Center" />
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{StaticResource BrushInputBorder}" />
                                <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.CellStyle>
                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem x:Name="EditStopLossBaselineMenuItem"
                                  Header="更改停損基準線"
                                  Click="OnEditStopLossBaselineClick" />
                        <MenuItem x:Name="ReverseSessionMenuItem"
                                  Header="立即反手"
                                  Click="OnReverseSessionClick" />
                        <MenuItem x:Name="CloseSessionMenuItem"
                                  Header="立即平倉"
                                  Click="OnCloseSessionClick" />
                    </ContextMenu>
                </DataGrid.ContextMenu>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="編號" Binding="{Binding Id}" Width="57.43">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTemplateColumn Header="開始時間" Width="151.76">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" TextAlignment="Center">
                                    <TextBlock.Text>
                                        <MultiBinding Converter="{StaticResource StartTimeDisplayConverter}">
                                            <Binding Path="StartTime" />
                                            <Binding Path="StartPosition" />
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTemplateColumn Header="狀態" Width="58.76">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" TextAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                            <Setter Property="Text" Value="進行中" />
                                            <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsFinished}" Value="True">
                                                    <Setter Property="Text" Value="結束" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsFailed}" Value="True">
                                                    <Setter Property="Text" Value="失敗" />
                                                    <Setter Property="Foreground" Value="#FFE6C15A" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="目前部位"
                                        Binding="{Binding Position, Converter={StaticResource PositionDisplayConverter}}"
                                        Width="86.76">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                                <Setter Property="Foreground">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource PositionBrushWithStatusConverter}">
                                            <Binding Path="Position" />
                                            <Binding Path="IsFinished" />
                                            <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.IsStrategyRunning" />
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="平均成本" Binding="{Binding AvgEntryPrice, StringFormat={}{0:F0}}" Width="85.76">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="浮動損益" Binding="{Binding FloatProfit, StringFormat={}{0:F0}}" Width="97.76">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="已平倉損益" Binding="{Binding RealizedProfit, StringFormat={}{0:F0}}" Width="96.6">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="任務損益" Binding="{Binding TotalProfit, StringFormat={}{0:F0}}" Width="96.6">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTemplateColumn Header="停損基準線" Width="96.6">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" TextAlignment="Center">
                                    <TextBlock.Text>
                                        <MultiBinding Converter="{StaticResource StopLossBaselineDisplayConverter}">
                                            <Binding Path="StopLossBaseline" />
                                            <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.CurrentStopLossMode" />
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="交易次數" Binding="{Binding TradeCount}" Width="74">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="最大總損失" Binding="{Binding MaxTotalLoss, StringFormat={}{0:F0}}" Width="96.6">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="{x:Type TextBlock}" BasedOn="{StaticResource {x:Type TextBlock}}">
                                <Setter Property="HorizontalAlignment" Value="Center" />
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="TextAlignment" Value="Center" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                </DataGrid.Columns>
                <DataGrid.RowStyle>
                    <Style TargetType="{x:Type DataGridRow}">
                        <Setter Property="Background" Value="#FF1F1F1F" />
                        <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{StaticResource BrushInputBorder}" />
                                <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsSelected" Value="True" />
                                    <Condition Property="Selector.IsSelectionActive" Value="False" />
                                </MultiTrigger.Conditions>
                                <Setter Property="Background" Value="{StaticResource BrushInputBorder}" />
                                <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                            </MultiTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
            </DataGrid>

            <Grid Grid.Row="0" Grid.Column="2" Margin="10,0,0,0" MinHeight="0"
                  IsEnabled="{Binding IsBacktestActive, Converter={StaticResource InverseBooleanConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Vertical" VerticalAlignment="Top" HorizontalAlignment="Stretch">
                    <Button Content="保證金查詢" Margin="0,0,0,6" HorizontalAlignment="Stretch"
                            IsEnabled="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.IsBrokerLoginSuccess}"
                            Command="{Binding QueryMarginCommand}" />
                    <Button Content="檢查憑證" Margin="0,0,0,6" HorizontalAlignment="Stretch"
                            IsEnabled="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.IsBrokerLoginSuccess}"
                            Command="{Binding CheckCertCommand}" />
                    <Separator Margin="0,6,0,12" Background="{StaticResource BrushSeparator}" />
                    <Button Content="建立新任務" Margin="0,0,0,6" HorizontalAlignment="Stretch"
                            IsEnabled="{Binding IsStrategyRunning}"
                            Click="OnCreateSessionClick" />
                    <Button Content="全部平倉" Margin="0,0,0,12" HorizontalAlignment="Stretch"
                            IsEnabled="{Binding IsStrategyRunning}"
                            Click="OnCloseAllSessionsClick" />
                    <Button x:Name="RolloverNowButton" Content="立刻換月" Margin="0,0,0,12" HorizontalAlignment="Stretch"
                            IsEnabled="{Binding IsStrategyRunning}"
                            Click="OnRolloverNowClick" />
                </StackPanel>

                <StackPanel Grid.Row="2" Orientation="Vertical" VerticalAlignment="Bottom" HorizontalAlignment="Stretch">
                    <RadioButton Content="真實交易"
                                 Margin="0,0,0,6"
                                 HorizontalAlignment="Center"
                                 GroupName="{Binding Index}"
                                 IsChecked="{Binding IsRealTrade, Mode=TwoWay}"
                                 IsEnabled="{Binding IsStrategyRunning}"
                                 PreviewMouseLeftButtonDown="OnRealTradePreviewMouseLeftButtonDown"
                                 Checked="OnRealTradeChecked">
                        <RadioButton.Style>
                            <Style TargetType="RadioButton" BasedOn="{StaticResource {x:Type RadioButton}}">
                                <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Foreground" Value="#FF2B2B2B" />
                                        <Setter Property="Opacity" Value="0.5" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </RadioButton.Style>
                    </RadioButton>
                    <RadioButton Content="模擬交易"
                                 Margin="0,0,0,10"
                                 HorizontalAlignment="Center"
                                 GroupName="{Binding Index}"
                                 IsChecked="{Binding IsRealTrade, Converter={StaticResource InverseBooleanConverter}, Mode=TwoWay}"
                                 IsEnabled="{Binding IsStrategyRunning}"
                                 Checked="OnSimTradeChecked">
                        <RadioButton.Style>
                            <Style TargetType="RadioButton" BasedOn="{StaticResource {x:Type RadioButton}}">
                                <Setter Property="Foreground" Value="{StaticResource BrushText}" />
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Foreground" Value="#FF2B2B2B" />
                                        <Setter Property="Opacity" Value="0.5" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </RadioButton.Style>
                    </RadioButton>
                    <Button Click="OnStrategyToggleClick"
                            HorizontalAlignment="Stretch"
                            Height="45"
                            IsEnabled="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.IsProgramStopped, Converter={StaticResource InverseBooleanConverter}}">
                        <TextBlock Text="{Binding StrategyButtonText}" FontSize="19" />
                    </Button>
                </StackPanel>
            </Grid>
        </Grid>
</UserControl>
